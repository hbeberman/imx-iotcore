Manufacturing
==============

This document describes the build configuration for manufacturing images along with the boot flow to do device provisioning on first boot.


## Configuration

### SRKH fusing
In order to enable High Assurance Boot, the Super Root Key Hash (SRKH) must be fused on your platform.

To obtain this value SPL pulls it out of the Flattened Device Tree (FDT) built into SPL.
During the build of SPL, the Common.mk buildscript will retrieve the SRKH values from the file defined by SRKH_FUSE_BIN near the top of the file. This file is generated by NXP's Code Signing Tool (CST) and contains the SRKH values corresponding to the keys allowed for High Assurance Boot.

Fusing the SRKH writes the values into OCOTP_SRK0 through OCOTP_SRK7.

The flow additionally sets the SEC_CONFIG fuse to 1, putting the paltform into Closed state on boot, meaning the Boot ROM will only start execution of loaded software if it's signature matches the keys allowed in the SRKH.

### MAC address fusing
On the i.MX6 Quad the MAC address is split between two fuses: OCOTP_MAC0, and OCOTP_MAC1

`spl_board_manufacture` sends the string "MFG:reqmac\n" out the serial line then awaits a response from a remote host. The host must respond to the MFG:reqmac request by sending the value to be fused into OCOTP_MAC0, then the value for OCOTP_MAC1 in sequence.

### U-Boot Configuration
The following two settings must be added to your U-Boot config to blow SRKH and MAC address fuses during manufacture. These also require a board specific version of spl_board_manufacture.

CONFIG_SPL_BOARD_MANUFACTURE=y
With this configuration set, U-Boot SPL will call the board specific function `spl_board_manufacture` from inside `board_init_r`. In the reference flow `spl_board_manufacture` is defined in `mx6cuboxi.c`

CONFIG_MANUFACTURE_FUSES=y
With this configuration set,`spl_board_manufacture` will actually perform permanent fusing operations on the SoC. Can be left disabled while testing the flow on boards that have already been fused.

### OP-TEE RPMB key generation and write once

When the fTPM and AuthVars TAs are running in OP-TEE they make requests to securely store nonvolatile data in the RPMB paritition of an onboard eMMC. In order to handle these writes and reads OP-TEE submits them to the OP-TEE supplicant who runs the storage driver on it's behalf. In the case of this BSP the OP-TEE suplicant RPMB transactions is UEFI, then once Windows has loaded the imxusdhc driver.

The RPMB relies on a write-once RPMB key that is used to encyrpt data retrieved from the eMMC, and to decrypt data sent to the eMMC. In order to program this value, OP-TEE submits a request to the supplicant and sends the key in plaintext to normal-world memory for the supplicant to then burn into the eMMC. This is an operation that *MUST* only be done in the factory, otherwise an attacker could swap eMMCs then intercept the same key computed in OP-TEE and use it to access secure data on the original eMMC.

In order to ensure this key write operation only occurs once a general purpose fuse is blown inside of OP-TEE after an eMMC is successfully keyed. The entry point of the key programming flow checks to see if the fuse is blown, and if so it will refuse to send the plaintext key to the supplicant again. In normal operation this path will not be hit more than once, as the key write function only occurs when OP-TEE detects that an eMMC is unkeyed.

The platform specific functions that must be defined are the following:
```C
TEE_Result tee_otp_check_rpmb_key_write_lock(void)
// Checks the RPMB key write-once fuse
// Returns TEE_ERROR_BAD_STATE if the fuse that forbids RPMB key writes is blown. Will cause an OP-TEE kernel panic on purpose.
// Returns TEE_SUCCESS if the fuse that forbids RPMB key writs is not blown.


TEE_Result tee_otp_set_rpmb_key_write_lock(void)
// Upon verification that the RPMB key was programmed successfully blows the RPMB key write-once fuse.
// Returns TEE_ERROR_BAD_STATE if the fuse blow operation fails. Will cause an OP-TEE kernel panic on purpose.
// Returns TEE_SUCCESS if the fuse blow operation succeeds.
```
The default implementations return TEE_SUCCESS so they're no-ops on platforms without explicit support.

### fTPM Endorsement Key Certificate

The fTPM Endorsement Key Certificate is the public key that can be used verify the authenticity of a TPM. In order to trust this EK Cert it must be extracted in the factory and must be stored by the OEM. The OEM then cross signs the EK Cert to assert that they trust it. This cross signed certificate should be persisted back onto the platform for convenience, but must also be avalable externally for future reference in-case the non-volatile storage on the device is reset.

The UEFI DXE driver defined in Provisioning.c opens a handle to the fTPM driver and requests the Endorsement Key Certificate. It signals the manufacturing PC that it's about to send the EK Cert by sending the string "MFG:ekcertstart\n" over serial, it then sends the EK Cert over serial byte by byte in hexadecimal. Once the certificate is complete the device sends "MFG:ekcertend\n" to signal to the manufacturing PC that the certificate is complete.

In anticipation of a cross signed cert, the device sends "MFG:devicecert\n" to the manufacturing host, then reads 4 bytes from serial to determine the length of buffer required for the cross signed certificate. The device then reads that many bytes from serial and writes the "ManufacturerDeviceCert" UEFI variable with this certificate buffer.

### SMBIOS Customizations

Some manufacturers may want to customize specific fields in the SMBIOS table with per-device values.

The SMBIOS tables are constructed during boot in [imx-edk2-platforms PlatformSmbiosDxe.c](https://github.com/ms-iot/imx-edk2-platforms/blob/imx/Silicon/NXP/iMX6Pkg/Drivers/PlatformSmbiosDxe/PlatformSmbiosDxe.c). Most of the values are pulled from the Platform Configuration Database (PCD) which are static oer board configuration. Some are generated dynamically based on values in fuses or the build time of the firmware. Values can be pulled out of UEFI variables with a fallback to default values if its not set. See the usage of RetrieveSmbiosVariable in PlatformSmbiosDxe.c as a reference.

These UEFI variables can be populated by a host PC over serial from the Provisioning UEFI DXE driver.

##First Boot

1) SPL boots to spl_board_manufacture.
2) spl_board_manufacture 